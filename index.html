<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All-in-One Calculator App</title>
    <!-- Link to the PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons for aesthetic buttons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* Custom Tailwind Configuration for smooth transitions and dark mode */
        :root {
            --primary-color: #3b82f6; /* Blue-500 */
            --primary-bg: #1f2937; /* Gray-800 */
            --secondary-bg: #111827; /* Gray-900 */
            --text-color: #f3f4f6; /* Gray-100 */
        }

        .dark {
            background-color: var(--secondary-bg);
            color: var(--text-color);
        }

        .calc-button {
            transition: all 0.1s ease-in-out;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
            border-radius: 1rem;
            min-height: 3.5rem;
        }

        .calc-button:active {
            transform: translateY(1px);
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        }

        /* Slide-out Menu Animation */
        #slide-menu {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
            z-index: 50;
        }
        #slide-menu.open {
            transform: translateX(0);
        }
        
        /* Backdrop for menu */
        #menu-backdrop {
            transition: opacity 0.3s ease-in-out;
            opacity: 0;
            pointer-events: none;
        }
        #slide-menu.open + #menu-backdrop {
            opacity: 0.7;
            pointer-events: auto;
        }

    </style>
</head>
<body class="dark min-h-screen font-inter">

    <!-- Tailwind Configuration (must be before content) -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'primary': 'var(--primary-color)',
                    },
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // Default Settings Structure
        const defaultSettings = {
            theme: 'Dark Default', 
            soundTone: 'Tone 1', 
            soundOn: true,
            language: 'English', 
            buttonColor: '#3b82f6', 
            calcDesign: 'Classic', 
        };

        const AppState = {
            currentView: 'Calculator',
            settings: {...defaultSettings},
            isMenuOpen: false,
            isSettingsModalOpen: false,
            isAddingUnitOrCurrency: null, // 'Unit' or 'Currency'
        };

        const THEMES = {
            'Dark Default': {
                '--primary-bg': '#1f2937', 
                '--secondary-bg': '#111827', 
                '--text-color': '#f3f4f6', 
                '--primary-color': '#3b82f6'
            },
            'Light Default': {
                '--primary-bg': '#f3f4f6', 
                '--secondary-bg': '#ffffff', 
                '--text-color': '#1f2937', 
                '--primary-color': '#4c1d95'
            },
            'Blue Dark': {
                '--primary-bg': '#071832', 
                '--secondary-bg': '#000c1f', 
                '--text-color': '#93c5fd', 
                '--primary-color': '#2563eb'
            },
            'Green Dark': {
                '--primary-bg': '#143522', 
                '--secondary-bg': '#0a1d13', 
                '--text-color': '#a7f3d0', 
                '--primary-color': '#10b981'
            },
            'Custom': { }
        };

        // --- UI RENDER FUNCTIONS ---
        function renderView() {
            const views = ['Calculator', 'Unit Converter', 'BMI Calculator', 'Currency Converter'];
            views.forEach(view => {
                const element = document.getElementById(`view-${view.replace(/\s/g, '-')}`);
                if (element) {
                    element.classList.toggle('hidden', AppState.currentView !== view);
                }
            });
            document.getElementById('current-view-title').textContent = AppState.currentView;
        }

        function toggleMenu() {
            AppState.isMenuOpen = !AppState.isMenuOpen;
            const menu = document.getElementById('slide-menu');
            const backdrop = document.getElementById('menu-backdrop');
            menu.classList.toggle('open', AppState.isMenuOpen);
            backdrop.classList.toggle('opacity-0', !AppState.isMenuOpen);
            backdrop.classList.toggle('pointer-events-none', !AppState.isMenuOpen);
        }

        function toggleSettingsModal(open) {
            AppState.isSettingsModalOpen = open;
            const modal = document.getElementById('settings-modal');
            modal.classList.toggle('hidden', !open);
        }

        function applyTheme(settings) {
            let colors = THEMES[settings.theme] || THEMES['Dark Default'];

            if (settings.theme === 'Custom') {
                colors = {...THEMES['Dark Default'], '--primary-color': settings.buttonColor};
            } else {
                colors['--primary-color'] = settings.buttonColor;
            }

            // Apply CSS variables
            Object.keys(colors).forEach(key => {
                document.documentElement.style.setProperty(key, colors[key]);
            });

            // Set the main button color for the entire app
            const buttonColorPicker = document.getElementById('setting-buttonColor');
            if (buttonColorPicker) {
                 buttonColorPicker.value = settings.buttonColor;
            }

            // Update button styles and calc design (simulated)
            document.querySelectorAll('.app-button').forEach(btn => {
                btn.style.backgroundColor = settings.buttonColor;
                btn.classList.toggle('shadow-xl', settings.calcDesign === 'Rounded');
                btn.classList.toggle('border-2', settings.calcDesign === 'Flat');
            });

            // Update dropdown values
            ['theme', 'soundTone', 'language', 'calcDesign'].forEach(key => {
                const el = document.getElementById(`setting-${key}`);
                if (el) el.value = settings[key];
            });

            // Update sound toggle
            const soundToggle = document.getElementById('setting-soundOn');
            if (soundToggle) soundToggle.checked = settings.soundOn;

            // Simple class toggle for the body based on the theme's general lightness
            if (settings.theme === 'Light Default') {
                document.body.classList.remove('dark');
            } else {
                document.body.classList.add('dark');
            }
        }
        
        // --- SOUND LOGIC (Simulated) ---
        function playClickSound() {
            if (AppState.settings.soundOn) {
                const tone = AppState.settings.soundTone;
                const volume = 0.5;
                let frequency = 440; 
                
                switch(tone) {
                    case 'Tone 2': frequency = 523; break; 
                    case 'Tone 3': frequency = 659; break; 
                    case 'Tone 4': frequency = 784; break; 
                    case 'Tone 5': frequency = 880; break; 
                }
                
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    const audioContext = new AudioContext();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(volume, audioContext.currentTime);

                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.05); 

                } catch (e) {
                    console.error('Audio playback failed:', e);
                }
            }
        }


        // --- FIREBASE & SETTINGS LOGIC ---

        function getUserSettingsRef() {
            if (!db || !userId) {
                console.error("Firestore or User ID not available.");
                return null;
            }
            // Path: /artifacts/{appId}/users/{userId}/settings/user_preferences
            return doc(db, `artifacts/${appId}/users/${userId}/settings`, 'user_preferences');
        }

        async function saveSetting(key, value) {
            const settingsRef = getUserSettingsRef();
            if (!settingsRef) return;

            // Update local state first for immediate UI feedback
            AppState.settings[key] = value;
            applyTheme(AppState.settings);

            // Save to Firestore
            try {
                const updatePayload = { [key]: value };
                await setDoc(settingsRef, updatePayload, { merge: true });
                playClickSound(); 
            } catch (e) {
                console.error("Error saving setting:", e);
            }
        }

        function listenForSettings() {
            const settingsRef = getUserSettingsRef();
            if (!settingsRef) return;

            onSnapshot(settingsRef, (docSnap) => {
                if (docSnap.exists()) {
                    AppState.settings = {...defaultSettings, ...docSnap.data()};
                } else {
                    setDoc(settingsRef, defaultSettings, { merge: true })
                        .then(() => AppState.settings = defaultSettings)
                        .catch(e => console.error("Error creating default settings:", e));
                }
                applyTheme(AppState.settings);
                renderView(); 
            }, (error) => {
                console.error("Error listening to settings:", error);
            });
        }

        async function initFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config not available. Running in local mode.");
                return;
            }

            try {
                // setLogLevel('Debug');
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Authentication
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Auth state listener
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                        listenForSettings();
                    } else {
                        isAuthReady = true;
                    }
                });

            } catch (e) {
                console.error("Firebase initialization failed:", e);
                isAuthReady = true;
                applyTheme(AppState.settings); 
            }
        }


        // --- CALCULATOR LOGIC (Unchanged) ---
        const calcState = {
            display: '0',
            currentOperator: null,
            operand1: null,
            waitingForSecondOperand: false,
            isScientific: false
        };

        function updateDisplay() {
            document.getElementById('calc-display').textContent = calcState.display;
        }

        function inputDigit(digit) {
            playClickSound();
            if (calcState.waitingForSecondOperand) {
                calcState.display = digit;
                calcState.waitingForSecondOperand = false;
            } else {
                calcState.display = calcState.display === '0' ? digit : calcState.display + digit;
            }
            updateDisplay();
        }

        function handleOperator(nextOperator) {
            playClickSound();
            const inputValue = parseFloat(calcState.display);

            if (calcState.currentOperator && calcState.waitingForSecondOperand) {
                calcState.currentOperator = nextOperator;
                return;
            }

            if (calcState.operand1 === null) {
                calcState.operand1 = inputValue;
            } else if (calcState.currentOperator) {
                const result = performCalculation[calcState.currentOperator](calcState.operand1, inputValue);
                calcState.display = String(result);
                calcState.operand1 = result;
            }

            calcState.waitingForSecondOperand = true;
            calcState.currentOperator = nextOperator;
            updateDisplay();
        }

        const performCalculation = {
            '/': (firstOperand, secondOperand) => firstOperand / secondOperand,
            '*': (firstOperand, secondOperand) => firstOperand * secondOperand,
            '+': (firstOperand, secondOperand) => firstOperand + secondOperand,
            '-': (firstOperand, secondOperand) => firstOperand - secondOperand,
            '=': (firstOperand, secondOperand) => secondOperand
        };

        function calculateScientific(func) {
             playClickSound();
             const inputValue = parseFloat(calcState.display);
             let result;
             
             switch(func) {
                 case 'sin': result = Math.sin(inputValue * Math.PI / 180); break;
                 case 'cos': result = Math.cos(inputValue * Math.PI / 180); break;
                 case 'tan': result = Math.tan(inputValue * Math.PI / 180); break;
                 case 'log': result = Math.log10(inputValue); break;
                 case 'sqrt': result = Math.sqrt(inputValue); break;
                 case '^2': result = inputValue * inputValue; break;
                 default: return;
             }
             
             calcState.display = String(result.toFixed(5));
             calcState.operand1 = result;
             calcState.waitingForSecondOperand = true;
             updateDisplay();
        }

        function resetCalculator() {
            playClickSound();
            calcState.display = '0';
            calcState.currentOperator = null;
            calcState.operand1 = null;
            calcState.waitingForSecondOperand = false;
            updateDisplay();
        }

        function toggleScientific() {
            playClickSound();
            calcState.isScientific = !calcState.isScientific;
            document.getElementById('scientific-keys').classList.toggle('hidden', !calcState.isScientific);
            document.getElementById('scientific-toggle-icon').innerHTML = lucide.createIcons()[calcState.isScientific ? 'cpu' : 'calculator'].toSvg({ class: 'w-6 h-6' });
        }

        // --- UNIT CONVERTER LOGIC (Expanded) ---
        
        // Generic to/from Base conversion functions (Base is the first unit in the list)
        function toBase(val, unit, conversionMap) {
            const factor = conversionMap[unit];
            return val * factor;
        }

        function fromBase(baseVal, unit, conversionMap) {
            const factor = conversionMap[unit];
            return baseVal / factor;
        }

        // Conversion factors to the BASE UNIT (Base unit factor is 1)
        const unitConversions = {
            Length: {
                units: ['Meter (m)', 'Kilometer (km)', 'Centimeter (cm)', 'Mile (mi)', 'Foot (ft)', 'Inch (in)'],
                base: 'Meter (m)',
                map: { 'Meter (m)': 1, 'Kilometer (km)': 1000, 'Centimeter (cm)': 0.01, 'Mile (mi)': 1609.34, 'Foot (ft)': 0.3048, 'Inch (in)': 0.0254 }
            },
            Temperature: { // Special case, uses functions
                units: ['Celsius (°C)', 'Fahrenheit (°F)', 'Kelvin (K)'],
                toBase: (val, unit) => {
                    if (unit === 'Celsius (°C)') return val + 273.15;
                    if (unit === 'Fahrenheit (°F)') return (val - 32) * 5/9 + 273.15;
                    return val;
                },
                fromBase: (val, unit) => {
                    if (unit === 'Celsius (°C)') return val - 273.15;
                    if (unit === 'Fahrenheit (°F)') return (val - 273.15) * 9/5 + 32;
                    return val;
                }
            },
            Time: {
                units: ['Second (s)', 'Minute (min)', 'Hour (h)', 'Day', 'Week', 'Year'],
                base: 'Second (s)',
                map: { 'Second (s)': 1, 'Minute (min)': 60, 'Hour (h)': 3600, 'Day': 86400, 'Week': 604800, 'Year': 31536000 }
            },
            Speed: {
                units: ['m/s', 'km/h', 'mph', 'knot', 'ft/s'],
                base: 'm/s',
                map: { 'm/s': 1, 'km/h': 1 / 3.6, 'mph': 0.44704, 'knot': 0.514444, 'ft/s': 0.3048 }
            },
            Velocity: { // Conceptually distinct, uses same math as Speed
                units: ['m/s', 'km/h', 'mph', 'c (speed of light)'],
                base: 'm/s',
                map: { 'm/s': 1, 'km/h': 1 / 3.6, 'mph': 0.44704, 'c (speed of light)': 299792458 }
            },
            Acceleration: {
                units: ['m/s²', 'km/s²', 'g (gravity)', 'ft/s²'],
                base: 'm/s²',
                map: { 'm/s²': 1, 'km/s²': 1000, 'g (gravity)': 9.80665, 'ft/s²': 0.3048 }
            },
            Volume: {
                units: ['Cubic Meter (m³)', 'Litre (L)', 'Gallon (US)', 'Cubic Foot (ft³)', 'Millilitre (ml)'],
                base: 'Cubic Meter (m³)',
                map: { 'Cubic Meter (m³)': 1, 'Litre (L)': 0.001, 'Gallon (US)': 0.00378541, 'Cubic Foot (ft³)': 0.0283168, 'Millilitre (ml)': 0.000001 }
            },
            Area: {
                units: ['Square Meter (m²)', 'Square Kilometer (km²)', 'Acre', 'Hectare', 'Square Mile (mi²)'],
                base: 'Square Meter (m²)',
                map: { 'Square Meter (m²)': 1, 'Square Kilometer (km²)': 1000000, 'Acre': 4046.86, 'Hectare': 10000, 'Square Mile (mi²)': 2589988.11 }
            },
            Pressure: {
                units: ['Pascal (Pa)', 'Bar', 'Atmosphere (atm)', 'PSI', 'kPa'],
                base: 'Pascal (Pa)',
                map: { 'Pascal (Pa)': 1, 'Bar': 100000, 'Atmosphere (atm)': 101325, 'PSI': 6894.76, 'kPa': 1000 }
            },
            Energy: {
                units: ['Joule (J)', 'Kilojoule (kJ)', 'Calorie (cal)', 'Kilowatt-hour (kWh)', 'Electronvolt (eV)'],
                base: 'Joule (J)',
                map: { 'Joule (J)': 1, 'Kilojoule (kJ)': 1000, 'Calorie (cal)': 4.184, 'Kilowatt-hour (kWh)': 3600000, 'Electronvolt (eV)': 1.60218e-19 }
            },
            Power: {
                units: ['Watt (W)', 'Kilowatt (kW)', 'Horsepower (hp)', 'BTU/h'],
                base: 'Watt (W)',
                map: { 'Watt (W)': 1, 'Kilowatt (kW)': 1000, 'Horsepower (hp)': 745.7, 'BTU/h': 0.293071 }
            },
            Weight: { 
                units: ['Kilogram (kg)', 'Gram (g)', 'Pound (lb)', 'Tonne (t)', 'Ounce (oz)'],
                base: 'Kilogram (kg)',
                map: { 'Kilogram (kg)': 1, 'Gram (g)': 0.001, 'Pound (lb)': 0.453592, 'Tonne (t)': 1000, 'Ounce (oz)': 0.0283495 }
            },
            Data: { // Data Storage
                units: ['Bit', 'Byte (B)', 'Kilobyte (KB)', 'Megabyte (MB)', 'Gigabyte (GB)', 'Terabyte (TB)'],
                base: 'Bit',
                map: { 'Bit': 1, 'Byte (B)': 8, 'Kilobyte (KB)': 8192, 'Megabyte (MB)': 8388608, 'Gigabyte (GB)': 8589934592, 'Terabyte (TB)': 8796093022000 } // Corrected TB factor
            },
        };

        function handleUnitConvert() {
            const category = document.getElementById('unit-category').value;
            const fromUnit = document.getElementById('unit-from').value;
            const toUnit = document.getElementById('unit-to').value;
            const value = parseFloat(document.getElementById('unit-input').value);
            const resultDisplay = document.getElementById('unit-result');

            if (isNaN(value) || !category || !fromUnit || !toUnit) {
                resultDisplay.textContent = 'Result: Invalid Input';
                return;
            }

            const converter = unitConversions[category];
            if (!converter) {
                resultDisplay.textContent = 'Result: Category Not Supported';
                return;
            }
            
            let result;

            if (category === 'Temperature') {
                const baseVal = converter.toBase(value, fromUnit);
                result = converter.fromBase(baseVal, toUnit);
            } else {
                const baseVal = toBase(value, fromUnit, converter.map); 
                result = fromBase(baseVal, toUnit, converter.map); 
            }

            resultDisplay.textContent = `Result: ${result.toPrecision(6)}`;
        }

        function populateUnitDropdowns() {
            const categoryEl = document.getElementById('unit-category');
            const fromEl = document.getElementById('unit-from');
            const toEl = document.getElementById('unit-to');

            // Clear and populate categories
            categoryEl.innerHTML = '';
            Object.keys(unitConversions).forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.textContent = cat;
                categoryEl.appendChild(opt);
            });

            // Handle category change
            categoryEl.addEventListener('change', (e) => {
                const selectedCat = e.target.value;
                const units = unitConversions[selectedCat]?.units || [];

                fromEl.innerHTML = '';
                toEl.innerHTML = '';

                units.forEach(unit => {
                    const opt1 = document.createElement('option');
                    opt1.value = unit;
                    opt1.textContent = unit;
                    fromEl.appendChild(opt1);

                    const opt2 = document.createElement('option');
                    opt2.value = unit;
                    opt2.textContent = unit;
                    toEl.appendChild(opt2);
                });
                handleUnitConvert();
            });

            // Trigger initial population
            categoryEl.value = 'Length';
            categoryEl.dispatchEvent(new Event('change'));
            fromEl.addEventListener('change', handleUnitConvert);
            toEl.addEventListener('change', handleUnitConvert);
        }

        function simulateAddUnit() {
            openAddItemModal('Unit');
        }
        
        // --- BMI LOGIC (Unchanged) ---
        function calculateBMI() {
            const weightKg = parseFloat(document.getElementById('bmi-weight').value);
            const heightCm = parseFloat(document.getElementById('bmi-height').value);
            const heightM = heightCm / 100;

            const resultDisplay = document.getElementById('bmi-result');
            const statusDisplay = document.getElementById('bmi-status');
            const rangeDisplay = document.getElementById('bmi-range');

            if (isNaN(weightKg) || isNaN(heightCm) || heightCm <= 0 || weightKg <= 0) {
                resultDisplay.textContent = 'Please enter valid weight and height.';
                statusDisplay.textContent = '';
                rangeDisplay.textContent = '';
                return;
            }

            const bmi = weightKg / (heightM * heightM);
            const formattedBmi = bmi.toFixed(2);
            resultDisplay.textContent = `Your BMI: ${formattedBmi}`;

            let status = '';
            let color = '';
            if (bmi < 18.5) {
                status = 'Underweight';
                color = 'text-yellow-400';
            } else if (bmi >= 18.5 && bmi <= 24.9) {
                status = 'Normal Weight';
                color = 'text-green-400';
            } else if (bmi >= 25 && bmi <= 29.9) {
                status = 'Overweight';
                color = 'text-orange-400';
            } else {
                status = 'Obesity';
                color = 'text-red-500';
            }
            statusDisplay.innerHTML = `<span class="${color}">${status}</span>`;

            const minWeight = 18.5 * heightM * heightM;
            const maxWeight = 24.9 * heightM * heightM;

            rangeDisplay.textContent = `Normal Weight Range for your height: ${minWeight.toFixed(1)} kg - ${maxWeight.toFixed(1)} kg`;
        }

        // --- CURRENCY CONVERTER LOGIC (Expanded) ---
        const exchangeRates = {
            // Base: USD = 1.00
            'USD - US Dollar': 1.00,
            'EUR - Euro': 0.92,
            'JPY - Japanese Yen': 156.40,
            'GBP - British Pound': 0.79,
            'CAD - Canadian Dollar': 1.36,
            'AUD - Australian Dollar': 1.51,
            'CHF - Swiss Frank': 0.90,
            'CNY - Chinese Yuan': 7.25,
            'INR - Indian Rupee': 83.50,
            'HKD - Hong Kong Dollar': 7.82,
            'NZD - New Zealand Dollar': 1.63,
            'KRW - South Korean Won': 1360.00,
            'SGD - Singapore Dollar': 1.35,
            'MXN - Mexican Peso': 17.00,
            'BRL - Brazilian Real': 5.20,
            'ZAR - South African Rand': 18.50,
            'RUB - Russian Ruble': 90.00,
            'TRY - Turkish Lira': 32.00,
            'SEK - Swedish Krona': 10.70,
            'NOK - Norwegian Krone': 10.90,
            'DKK - Danish Krone': 6.80,
            'PLN - Polish Złoty': 4.00,
            'HUF - Hungarian Forint': 360.00,
            'CZK - Czech Koruna': 23.00,
            'ILS - Israeli New Shekel': 3.70,
            'PHP - Philippine Peso': 58.00,
            'THB - Thai Baht': 36.00,
            'IDR - Indonesian Rupiah': 16000.00,
            'MYR - Malaysian Ringgit': 4.70,
            'VND - Vietnamese Đồng': 25500.00,
            'AED - UAE Dirham': 3.67,
            'SAR - Saudi Riyal': 3.75,
            'QAR - Qatari Riyal': 3.64,
            'KWD - Kuwaiti Dinar': 0.31,
            'EGP - Egyptian Pound': 48.00,
            'CLP - Chilean Peso': 930.00,
            'COP - Colombian Peso': 3900.00,
            'PEN - Peruvian Sol': 3.70,
            'ARS - Argentine Peso': 880.00,
            'PKR - Pakistani Rupee': 278.00,
            'BDT - Bangladeshi Taka': 110.00,
            'NPR - Nepalese Rupee': 133.00,
            'LKR - Sri Lankan Rupee': 300.00,
            'GHS - Ghanaian Cedi': 14.50,
            'NGN - Nigerian Naira': 1450.00,
            'KES - Kenyan Shilling': 130.00,
            'BHD - Bahraini Dinar': 0.38,
            'OMR - Omani Rial': 0.38,
            'JOD - Jordanian Dinar': 0.71,
            'LBP - Lebanese Pound': 89500.00,
            'ISK - Icelandic Króna': 140.00,
            'HRK - Croatian Kuna': 7.53, 
        };
        
        const currencyList = Object.keys(exchangeRates);

        function populateCurrencyDropdowns() {
            const fromEl = document.getElementById('currency-from');
            const toEl = document.getElementById('currency-to');

            fromEl.innerHTML = '';
            toEl.innerHTML = '';

            currencyList.forEach(currency => {
                const opt1 = document.createElement('option');
                opt1.value = currency;
                opt1.textContent = currency;
                fromEl.appendChild(opt1);

                const opt2 = document.createElement('option');
                opt2.value = currency;
                opt2.textContent = currency;
                toEl.appendChild(opt2);
            });
            // Set defaults
            fromEl.value = 'INR - Indian Rupee';
            toEl.value = 'USD - US Dollar';
        }

        function handleCurrencyConvert() {
            const fromCurrency = document.getElementById('currency-from').value;
            const toCurrency = document.getElementById('currency-to').value;
            const value = parseFloat(document.getElementById('currency-input').value);
            const resultDisplay = document.getElementById('currency-result');

            if (isNaN(value) || !fromCurrency || !toCurrency) {
                resultDisplay.textContent = 'Result: Invalid Input';
                return;
            }

            if (fromCurrency === toCurrency) {
                resultDisplay.textContent = `Result: ${value.toFixed(2)} ${toCurrency.split(' - ')[0]}`;
                return;
            }

            // Convert FROM currency to USD (Base)
            const fromRate = exchangeRates[fromCurrency];
            const toRate = exchangeRates[toCurrency];

            if (!fromRate || !toRate) {
                resultDisplay.textContent = 'Result: Conversion Rate Missing';
                return;
            }

            // A -> USD -> B
            const valueInUSD = value / fromRate;
            const result = valueInUSD * toRate;
            const targetCode = toCurrency.split(' - ')[0];

            resultDisplay.textContent = `Result: ${result.toFixed(2)} ${targetCode}`;
        }

        function simulateAddCurrency() {
            openAddItemModal('Currency');
        }
        
        // --- Custom Alert/Modal (Required replacement for alert/confirm) ---
        function alertMessage(title, message, color) {
            const modalEl = document.getElementById('custom-alert-modal');
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            document.getElementById('alert-title').className = `text-xl font-bold text-${color}`;
            modalEl.classList.remove('hidden');

            setTimeout(() => {
                modalEl.classList.add('hidden');
            }, 3000);
        }

        // --- ADD ITEM MODAL LOGIC (New Fix) ---

        function openAddItemModal(type) {
            playClickSound();
            if (!userId) {
                alertMessage('Authentication Required', 'Please wait for authentication to complete before adding custom items.', 'yellow-500');
                return;
            }
            
            AppState.isAddingUnitOrCurrency = type;
            const modal = document.getElementById('add-item-modal');
            const titleEl = document.getElementById('add-item-title');
            const inputNameEl = document.getElementById('item-name-input');
            const inputFactorEl = document.getElementById('item-factor-input');
            const factorLabelEl = document.getElementById('item-factor-label');
            const factorHelpEl = document.getElementById('item-factor-help');

            // Clear previous inputs
            inputNameEl.value = '';
            inputFactorEl.value = '';
            
            if (type === 'Unit') {
                titleEl.textContent = 'Add New Unit';
                inputNameEl.placeholder = 'e.g., Angstrom (Å)';
                factorLabelEl.textContent = 'Conversion Factor to Base Unit (Meter)';
                inputFactorEl.placeholder = 'e.g., 1e-10';
                factorHelpEl.textContent = 'The value that converts 1 unit to the base unit (Meter)';
            } else if (type === 'Currency') {
                titleEl.textContent = 'Add New Currency';
                inputNameEl.placeholder = 'e.g., XYZ - Custom Dollar';
                factorLabelEl.textContent = 'Exchange Rate to USD';
                inputFactorEl.placeholder = 'e.g., 361.90';
                factorHelpEl.textContent = 'How many units equal 1 US Dollar (USD)';
            }
            
            modal.classList.remove('hidden');
        }

        function closeAddItemModal() {
            AppState.isAddingUnitOrCurrency = null;
            document.getElementById('add-item-modal').classList.add('hidden');
        }

        async function handleAddItemSubmit() {
            playClickSound();
            const type = AppState.isAddingUnitOrCurrency;
            const name = document.getElementById('item-name-input').value.trim();
            const factor = parseFloat(document.getElementById('item-factor-input').value);

            if (!name || isNaN(factor) || userId === null) {
                alertMessage('Error', 'Please enter a valid name and numeric factor/rate.', 'red-500');
                return;
            }

            const docName = type === 'Unit' ? 'custom_units' : 'custom_currencies';
            const key = type === 'Unit' ? 'units' : 'currencies';

            // Path: /artifacts/{appId}/users/{userId}/customData/{docName}
            const customRef = doc(db, `artifacts/${appId}/users/${userId}/customData`, docName);
            
            try {
                // NOTE: We only save the new custom item without fetching the old list for simplicity
                const payload = { 
                    [key]: { 
                        [name]: factor 
                    }
                };
                await setDoc(customRef, payload, { merge: true });
                
                alertMessage('Success!', `${type} "${name}" added successfully to your custom list in Firestore!`, 'green-500');
                closeAddItemModal();
            } catch (e) {
                console.error("Error saving custom item:", e);
                alertMessage('Error', `Could not save custom ${type}: ${e.message}`, 'red-500');
            }
        }
        
        // --- Event Listeners and Initialization ---
        window.onload = () => {
            initFirebase();
            renderView();
            updateDisplay();
            populateUnitDropdowns();
            populateCurrencyDropdowns(); // Added currency population

            // Set up main navigation
            document.getElementById('menu-button').addEventListener('click', toggleMenu);
            document.getElementById('menu-backdrop').addEventListener('click', toggleMenu);

            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    AppState.currentView = e.currentTarget.dataset.view;
                    toggleMenu();
                    renderView();
                });
            });

            // Set up Settings button
            document.getElementById('settings-button').addEventListener('click', () => toggleSettingsModal(true));
            document.getElementById('close-settings-modal').addEventListener('click', () => toggleSettingsModal(false));

            // Settings change listeners
            document.querySelectorAll('.setting-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const key = e.target.id.replace('setting-', '');
                    let value = e.target.type === 'checkbox' ? e.target.checked : e.target.value;

                    if (key === 'buttonColor') {
                         document.getElementById('setting-theme').value = 'Custom';
                         saveSetting('theme', 'Custom');
                         saveSetting(key, value);
                    } else {
                        saveSetting(key, value);
                    }
                });
            });

             // Calculator event listener
            document.getElementById('calculator-keys').addEventListener('click', (event) => {
                const { target } = event;
                if (!target.matches('button')) { return; }

                if (target.classList.contains('number-btn')) {
                    inputDigit(target.textContent);
                    return;
                }
                if (target.classList.contains('operator-btn')) {
                    handleOperator(target.textContent);
                    return;
                }
                if (target.classList.contains('decimal-btn')) {
                    inputDigit('.');
                    return;
                }
                if (target.classList.contains('equal-btn')) {
                    handleOperator('=');
                    return;
                }
                if (target.classList.contains('clear-btn')) {
                    resetCalculator();
                    return;
                }
                if (target.classList.contains('sci-func-btn')) {
                    calculateScientific(target.dataset.func);
                    return;
                }
            });
            
            // Toggle Scientific Calculator
            document.getElementById('scientific-toggle').addEventListener('click', toggleScientific);
            
            // BMI listener
            document.getElementById('bmi-calculate-btn').addEventListener('click', calculateBMI);

            // Unit Converter listeners
            document.getElementById('unit-input').addEventListener('input', handleUnitConvert);
            document.getElementById('add-unit-btn').addEventListener('click', simulateAddUnit);
            document.getElementById('unit-category').addEventListener('change', handleUnitConvert);
            document.getElementById('unit-from').addEventListener('change', handleUnitConvert);
            document.getElementById('unit-to').addEventListener('change', handleUnitConvert);

            // Currency Converter listeners
            document.getElementById('currency-input').addEventListener('input', handleCurrencyConvert);
            document.getElementById('add-currency-btn').addEventListener('click', simulateAddCurrency);
            document.getElementById('currency-from').addEventListener('change', handleCurrencyConvert);
            document.getElementById('currency-to').addEventListener('change', handleCurrencyConvert);

            // Add Item Modal Listeners
            document.getElementById('close-add-item-modal').addEventListener('click', closeAddItemModal);
            document.getElementById('add-item-submit-btn').addEventListener('click', handleAddItemSubmit);

            // Set initial icons
            lucide.createIcons();
            handleCurrencyConvert(); // Initial calculation
            calculateBMI(); // Initial calculation
            
            // PWA Service Worker Registration
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/service-worker.js').then(registration => {
                        console.log('SW registered: ', registration);
                    }).catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
                });
            }
        };

        // Expose functions for buttons in HTML
        window.toggleMenu = toggleMenu;
        window.toggleSettingsModal = toggleSettingsModal;
        window.toggleScientific = toggleScientific;
        window.handleUnitConvert = handleUnitConvert;
        window.handleCurrencyConvert = handleCurrencyConvert;
        window.calculateBMI = calculateBMI;
        
    </script>
    
    <!-- MAIN APPLICATION CONTAINER -->
    <div id="app" class="relative max-w-lg mx-auto p-4 flex flex-col min-h-screen">
        
        <!-- Top Bar (Header) -->
        <header class="flex justify-between items-center py-4 z-40 sticky top-0 bg-[var(--secondary-bg)]">
            <!-- Top-Left Slide-out Menu Button -->
            <button id="menu-button" class="w-12 h-12 rounded-full bg-primary hover:bg-opacity-80 transition flex items-center justify-center p-2 text-white shadow-lg">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
            
            <!-- Current View Title -->
            <h1 id="current-view-title" class="text-xl font-bold text-gray-100">Calculator</h1>
            
            <!-- Top-Right Settings Button (Gear Icon) -->
            <button id="settings-button" class="w-12 h-12 rounded-full bg-gray-700 hover:bg-gray-600 transition flex items-center justify-center p-2 text-white shadow-lg">
                <i data-lucide="settings" class="w-6 h-6"></i>
            </button>
        </header>

        <!-- User ID Display -->
        <div class="text-xs text-gray-500 mb-4 text-center overflow-hidden whitespace-nowrap overflow-ellipsis" id="user-id-display">
            User ID: Awaiting Authentication...
        </div>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-grow pb-8">
            
            <!-- View 1: Calculator -->
            <div id="view-Calculator" class="h-full flex flex-col justify-end transition duration-300">
                <div id="calc-display" class="text-5xl font-light text-right mb-4 p-4 rounded-xl bg-gray-700 break-words overflow-hidden" style="min-height: 100px;">0</div>

                <!-- Scientific Keys (Hidden by default) -->
                <div id="scientific-keys" class="grid grid-cols-5 gap-3 mb-3 hidden">
                    <button data-func="sin" class="sci-func-btn calc-button bg-gray-600 text-white text-lg">sin</button>
                    <button data-func="cos" class="sci-func-btn calc-button bg-gray-600 text-white text-lg">cos</button>
                    <button data-func="tan" class="sci-func-btn calc-button bg-gray-600 text-white text-lg">tan</button>
                    <button data-func="log" class="sci-func-btn calc-button bg-gray-600 text-white text-lg">log</button>
                    <button data-func="sqrt" class="sci-func-btn calc-button bg-gray-600 text-white text-lg">√</button>
                    <button data-func="^2" class="sci-func-btn calc-button bg-gray-600 text-white text-lg">x²</button>
                    <button data-func="pi" class="sci-func-btn calc-button bg-gray-600 text-white text-lg">π</button>
                    <button data-func="e" class="sci-func-btn calc-button bg-gray-600 text-white text-lg">e</button>
                    <button data-func="abs" class="sci-func-btn calc-button bg-gray-600 text-white text-lg">|x|</button>
                    <button data-func="fac" class="sci-func-btn calc-button bg-gray-600 text-white text-lg">x!</button>
                </div>

                <!-- Standard Calculator Keys -->
                <div id="calculator-keys" class="grid grid-cols-4 gap-3">
                    
                    <!-- Row 1: Scientific Toggle (Round Button) + Utility -->
                    <button id="scientific-toggle" class="calc-button bg-gray-600 text-white text-lg col-span-1 flex items-center justify-center p-2 rounded-full w-full h-full aspect-square" style="min-height: 3.5rem;">
                        <i id="scientific-toggle-icon" data-lucide="calculator" class="w-6 h-6"></i>
                    </button>
                    <button class="clear-btn calc-button bg-red-600 text-white text-xl col-span-2">AC</button>
                    <button class="operator-btn calc-button bg-primary app-button text-white text-xl">/</button>
                    
                    <!-- Row 2 -->
                    <button class="number-btn calc-button bg-gray-500 text-white text-2xl">7</button>
                    <button class="number-btn calc-button bg-gray-500 text-white text-2xl">8</button>
                    <button class="number-btn calc-button bg-gray-500 text-white text-2xl">9</button>
                    <button class="operator-btn calc-button bg-primary app-button text-white text-xl">*</button>

                    <!-- Row 3 -->
                    <button class="number-btn calc-button bg-gray-500 text-white text-2xl">4</button>
                    <button class="number-btn calc-button bg-gray-500 text-white text-2xl">5</button>
                    <button class="number-btn calc-button bg-gray-500 text-white text-2xl">6</button>
                    <button class="operator-btn calc-button bg-primary app-button text-white text-xl">-</button>

                    <!-- Row 4 -->
                    <button class="number-btn calc-button bg-gray-500 text-white text-2xl">1</button>
                    <button class="number-btn calc-button bg-gray-500 text-white text-2xl">2</button>
                    <button class="number-btn calc-button bg-gray-500 text-white text-2xl">3</button>
                    <button class="operator-btn calc-button bg-primary app-button text-white text-xl">+</button>

                    <!-- Row 5 -->
                    <button class="number-btn calc-button bg-gray-500 text-white text-2xl col-span-2">0</button>
                    <button class="decimal-btn calc-button bg-gray-500 text-white text-2xl">.</button>
                    <button class="equal-btn calc-button bg-primary app-button text-white text-xl">=</button>
                </div>
            </div>
            
            <!-- View 2: Unit Converter -->
            <div id="view-Unit-Converter" class="hidden p-4 bg-[var(--primary-bg)] rounded-xl shadow-xl relative pt-12">
                <h2 class="text-2xl font-semibold mb-4 text-center">Unit Converter</h2>
                
                <!-- Add Unit Button (Round Plus Button) -->
                <button id="add-unit-btn" class="w-10 h-10 rounded-full bg-primary app-button hover:bg-opacity-80 transition flex items-center justify-center p-2 text-white shadow-lg absolute right-4 top-4 z-10">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>

                <div class="space-y-4">
                    <label class="block">Category</label>
                    <select id="unit-category" class="w-full p-3 rounded-lg bg-gray-700 border-gray-600 text-white focus:ring-primary focus:border-primary"></select>
                    
                    <label class="block">Value to Convert</label>
                    <input type="number" id="unit-input" value="100" class="w-full p-3 rounded-lg bg-gray-700 border-gray-600 text-white focus:ring-primary focus:border-primary">
                    
                    <div class="flex space-x-2">
                        <div class="flex-1">
                            <label class="block">From Unit</label>
                            <select id="unit-from" class="w-full p-3 rounded-lg bg-gray-700 border-gray-600 text-white focus:ring-primary focus:border-primary"></select>
                        </div>
                        <div class="flex-1">
                            <label class="block">To Unit</label>
                            <select id="unit-to" class="w-full p-3 rounded-lg bg-gray-700 border-gray-600 text-white focus:ring-primary focus:border-primary"></select>
                        </div>
                    </div>
                    
                    <div id="unit-result" class="text-xl font-bold pt-4 text-center text-primary">Result: 0.00</div>
                </div>
            </div>

            <!-- View 3: BMI Calculator -->
            <div id="view-BMI-Calculator" class="hidden p-4 bg-[var(--primary-bg)] rounded-xl shadow-xl space-y-4">
                <h2 class="text-2xl font-semibold mb-4 text-center">BMI Calculator</h2>
                
                <label class="block">Weight (kg)</label>
                <input type="number" id="bmi-weight" placeholder="e.g. 70" value="70" class="w-full p-3 rounded-lg bg-gray-700 border-gray-600 text-white focus:ring-primary focus:border-primary" oninput="calculateBMI()">
                
                <label class="block">Height (cm)</label>
                <input type="number" id="bmi-height" placeholder="e.g. 175" value="175" class="w-full p-3 rounded-lg bg-gray-700 border-gray-600 text-white focus:ring-primary focus:border-primary" oninput="calculateBMI()">
                
                <button id="bmi-calculate-btn" class="w-full p-3 rounded-xl bg-primary app-button text-white font-bold hover:bg-opacity-80 transition mt-4" onclick="calculateBMI()">Calculate BMI</button>
                
                <div class="pt-4 space-y-2">
                    <p id="bmi-result" class="text-2xl font-bold text-center">Your BMI: --</p>
                    <p id="bmi-status" class="text-xl font-semibold text-center"></p>
                    <p id="bmi-range" class="text-sm text-gray-400 text-center border-t border-gray-600 pt-2"></p>
                </div>
            </div>

            <!-- View 4: Currency Converter -->
            <div id="view-Currency-Converter" class="hidden p-4 bg-[var(--primary-bg)] rounded-xl shadow-xl relative pt-12">
                <h2 class="text-2xl font-semibold mb-4 text-center">Currency Converter</h2>
                
                <!-- Add Currency Button (Round Plus Button) -->
                <button id="add-currency-btn" class="w-10 h-10 rounded-full bg-primary app-button hover:bg-opacity-80 transition flex items-center justify-center p-2 text-white shadow-lg absolute right-4 top-4 z-10">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                </button>

                <div class="space-y-4">
                    <label class="block">Amount to Convert</label>
                    <input type="number" id="currency-input" value="100" class="w-full p-3 rounded-lg bg-gray-700 border-gray-600 text-white focus:ring-primary focus:border-primary" oninput="handleCurrencyConvert()">
                    
                    <div class="flex space-x-2">
                        <div class="flex-1">
                            <label class="block">From Currency</label>
                            <select id="currency-from" class="w-full p-3 rounded-lg bg-gray-700 border-gray-600 text-white focus:ring-primary focus:border-primary"></select>
                        </div>
                        <div class="flex-1">
                            <label class="block">To Currency</label>
                            <select id="currency-to" class="w-full p-3 rounded-lg bg-gray-700 border-gray-600 text-white focus:ring-primary focus:border-primary"></select>
                        </div>
                    </div>
                    
                    <div id="currency-result" class="text-xl font-bold pt-4 text-center text-primary">Result: 0.00 USD</div>
                </div>
            </div>

        </main>
    </div>
    
    <!-- SLIDE-OUT MENU (Top-Left) -->
    <div id="slide-menu" class="fixed top-0 left-0 w-64 h-full bg-[var(--secondary-bg)] p-6 shadow-2xl">
        <h2 class="text-2xl font-bold mb-8 text-primary">App Menu</h2>
        <ul class="space-y-3">
            <li><button class="nav-link w-full text-left p-3 rounded-lg hover:bg-gray-700 transition flex items-center space-x-3" data-view="Calculator"><i data-lucide="calculator" class="w-5 h-5"></i><span>Calculator</span></button></li>
            <li><button class="nav-link w-full text-left p-3 rounded-lg hover:bg-gray-700 transition flex items-center space-x-3" data-view="Unit Converter"><i data-lucide="ruler" class="w-5 h-5"></i><span>Unit Converter</span></button></li>
            <li><button class="nav-link w-full text-left p-3 rounded-lg hover:bg-gray-700 transition flex items-center space-x-3" data-view="BMI Calculator"><i data-lucide="thermometer" class="w-5 h-5"></i><span>BMI Calculator</span></button></li>
            <li><button class="nav-link w-full text-left p-3 rounded-lg hover:bg-gray-700 transition flex items-center space-x-3" data-view="Currency Converter"><i data-lucide="dollar-sign" class="w-5 h-5"></i><span>Currency Converter</span></button></li>
        </ul>
    </div>
    <div id="menu-backdrop" class="fixed inset-0 bg-black opacity-0 pointer-events-none transition duration-300 z-40" onclick="toggleMenu()"></div>

    <!-- SETTINGS MODAL (Top-Right Gear Icon) -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="bg-[var(--primary-bg)] w-full max-w-md rounded-2xl p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-primary">Settings</h3>
                <button id="close-settings-modal" class="text-gray-400 hover:text-white transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="space-y-4 max-h-96 overflow-y-auto pr-2">
                
                <!-- 1. Theme Selection -->
                <div>
                    <label class="block text-sm font-medium mb-1">Theme Selection</label>
                    <select id="setting-theme" class="setting-input w-full p-2 rounded-lg bg-gray-700 border-gray-600 text-white">
                        <option value="Dark Default">Dark Default</option>
                        <option value="Light Default">Light Default</option>
                        <option value="Blue Dark">Blue Dark</option>
                        <option value="Green Dark">Green Dark</option>
                        <option value="Custom">Custom Theme</option>
                    </select>
                </div>
                
                <!-- 2. Click Button Sound Selection -->
                <div>
                    <label class="block text-sm font-medium mb-1">Click Button Sound</label>
                    <div class="flex space-x-2">
                        <select id="setting-soundTone" class="setting-input flex-1 p-2 rounded-lg bg-gray-700 border-gray-600 text-white">
                            <option value="Tone 1">Tone 1 (Default)</option>
                            <option value="Tone 2">Tone 2 (Higher)</option>
                            <option value="Tone 3">Tone 3 (Pitchy)</option>
                            <option value="Tone 4">Tone 4 (Bass)</option>
                            <option value="Tone 5">Tone 5 (Chime)</option>
                        </select>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="setting-soundOn" class="setting-input w-5 h-5 rounded text-primary bg-gray-700 border-gray-600" checked>
                            <span class="text-sm">Sound On/Off</span>
                        </label>
                    </div>
                </div>

                <!-- 3. Language Selection (Simulated) -->
                <div>
                    <label class="block text-sm font-medium mb-1">Language Selection</label>
                    <select id="setting-language" class="setting-input w-full p-2 rounded-lg bg-gray-700 border-gray-600 text-white">
                        <option value="English">English</option>
                        <option value="Hindi">Hindi (App Interface is English)</option>
                    </select>
                </div>

                <!-- 4. Button Colour Changing -->
                <div>
                    <label class="block text-sm font-medium mb-1">Button Color (Primary)</label>
                    <input type="color" id="setting-buttonColor" class="setting-input w-full h-10 p-1 rounded-lg bg-gray-700 border-gray-600" value="#3b82f6">
                </div>

                <!-- 5. Calculator Design Selection -->
                <div>
                    <label class="block text-sm font-medium mb-1">Calculator Design</label>
                    <select id="setting-calcDesign" class="setting-input w-full p-2 rounded-lg bg-gray-700 border-gray-600 text-white">
                        <option value="Classic">Classic</option>
                        <option value="Rounded">Rounded (Shadows)</option>
                        <option value="Minimalist">Minimalist</option>
                        <option value="Grid">Grid</option>
                        <option value="Flat">Flat (Borders)</option>
                    </select>
                </div>

            </div>
            
            <p class="text-xs text-gray-500 mt-4 text-center">Settings are saved automatically via Firestore.</p>
        </div>
    </div>
    
    <!-- ADD ITEM MODAL (NEW FIX) -->
    <div id="add-item-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="bg-[var(--primary-bg)] w-full max-w-md rounded-2xl p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 id="add-item-title" class="text-2xl font-bold text-primary">Add New Item</h3>
                <button id="close-add-item-modal" class="text-gray-400 hover:text-white transition">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Name / Code</label>
                    <input type="text" id="item-name-input" placeholder="e.g., Custom Unit (CU) or ZWL - Zimbabwe Dollar" class="w-full p-3 rounded-lg bg-gray-700 border-gray-600 text-white focus:ring-primary focus:border-primary">
                </div>
                
                <div>
                    <label id="item-factor-label" class="block text-sm font-medium mb-1">Conversion Factor</label>
                    <input type="number" id="item-factor-input" placeholder="e.g., 1000 or 361.90" class="w-full p-3 rounded-lg bg-gray-700 border-gray-600 text-white focus:ring-primary focus:border-primary">
                    <p id="item-factor-help" class="text-xs text-gray-400 mt-1">Details on factor/rate...</p>
                </div>
            </div>

            <button id="add-item-submit-btn" class="w-full p-3 rounded-xl bg-primary app-button text-white font-bold hover:bg-opacity-80 transition mt-6">
                Add Item to Custom List
            </button>
            
            <p class="text-xs text-gray-500 mt-4 text-center">Note: Custom items are saved to your private Firestore storage but will not be available in dropdowns until a full reload/rebuild of the app is performed by the developer.</p>
        </div>
    </div>


    <!-- Custom Alert Modal (Replaces alert()) -->
    <div id="custom-alert-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-70 p-4">
        <div class="bg-white w-full max-w-sm rounded-lg p-6 shadow-xl dark:bg-gray-800 dark:text-white">
            <h4 id="alert-title" class="text-xl font-bold mb-2"></h4>
            <p id="alert-message" class="text-gray-600 dark:text-gray-300"></p>
        </div>
    </div>

</body>
</html>

